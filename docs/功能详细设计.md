# macOS 实时语音转文字助手 —— 功能详细设计（MVP v2）

## 版本变更记录

| 版本 | 日期 | 变更人 | 说明 |
|---|---|---|---|
| v2.0 | 2026-02-21 | 设计评审整改 | 全文改为六段式模块定义；新增接口契约、状态机、错误码、可观测字段与统一参数。 |
| v1.0 | 2026-02-21 | 初稿 | 初始模块设计。 |

---

## 一、术语表

| 术语 | 定义 |
|---|---|
| Session | 从快捷键按下到上屏完成的一次完整语音输入过程。 |
| PartialResult | 识别中间文本结果，允许覆盖更新。 |
| FinalResult | 会话最终文本结果。 |
| Sentinel | 音频队列结束标记 `None`。 |
| 可观测字段 | 日志与指标字段，用于排障与验收。 |

---

## 二、统一参数表

| 参数 | 值 | 说明 |
|---|---|---|
| 采样率 | 16000 Hz | 固定输入规格 |
| 声道 | Mono (1) | 固定输入规格 |
| 位深 | PCM 16-bit | 固定输入规格 |
| 音频块大小 | 100 ms | 固定 |
| 队列容量 | 50 | 超限时触发丢弃计数与告警日志 |
| 录音上限 | 300 s | 超时自动 stop |
| Final 等待超时 | 3 s | `stop_session()` 后等待 Final |
| 网络请求超时 | 10 s | 单次识别请求超时 |
| 剪贴板恢复延迟 | 100 ms | 粘贴后恢复文本剪贴板 |

---

## 三、非目标范围（Out of Scope）

1. 富媒体剪贴板（图片/富文本）完整恢复保证。
2. 多平台兼容（仅 macOS）。
3. 企业级监控平台对接与审计流水。
4. 多模型自动切换与 AB 试验。

---

## 四、全局状态机

```text
IDLE -> RECORDING -> FINALIZING -> PASTING -> IDLE
  |         |             |            |
  +-------->+------------>+----------> ERROR -> IDLE
```

状态定义：
1. `IDLE`：空闲待命。
2. `RECORDING`：持续采集音频并推队列。
3. `FINALIZING`：停止录音，等待识别最终结果。
4. `PASTING`：执行粘贴与剪贴板恢复。
5. `ERROR`：错误处理和资源清理。

---

## 五、模块详细设计（六段式）

## 模块 1：SessionController（会话编排核心）

### 输入
- `start_session()` 调用。
- `stop_session()` 调用。
- 子模块事件：`RecognitionEvent`、权限失败、超时、内部异常。

### 输出
- 状态转换事件。
- 对录音/识别/上屏模块的调用。
- UI 状态通知（托盘图标、悬浮窗文本）。

### 前置条件
- `ConfigStore` 已可读取 API Key 和热键。
- 热键、录音、识别、上屏服务均已初始化。

### 失败处理
- 幂等拒绝重复 `start/stop`。
- 出错时统一生成错误码并切换到 `ERROR`。
- 清理后回 `IDLE`，避免卡死状态。

### 超时策略
- `stop_session()` 后等待 Final 最多 3 秒。
- 超时触发 `ASR_PROTOCOL_ERROR` 并执行降级处理（可保留中间文本）。

### 可观测字段
- `session_id`、`state_from`、`state_to`、`cost_ms`、`error_code`。

---

## 模块 2：TrayController + OverlayView（托盘与悬浮窗）

### 输入
- `SessionController` 发出的状态与文本事件。
- 用户菜单动作（设置 API Key、设置热键、退出）。

### 输出
- 托盘图标状态变化（空闲/录音/错误）。
- 悬浮窗中间文本、最终状态提示。

### 前置条件
- `QApplication` 已启动。
- 资源图标与窗口样式可正常加载。

### 失败处理
- UI 渲染异常仅记录日志，不中断会话主流程。
- 设置保存失败显示可读提示，并保留旧配置。

### 超时策略
- 错误提示显示 2 秒自动隐藏。
- 会话结束后悬浮窗延迟 300-500ms 隐藏。

### 可观测字段
- `overlay_show_count`、`overlay_update_count`、`ui_error_count`。

---

## 模块 3：HotkeyAdapter（热键适配层）

### 输入
- 系统按键按下/抬起事件。

### 输出
- 统一事件：`press`、`release`。

### 前置条件
- 辅助功能权限已授予。
- 已配置热键组合（默认 `Option` 长按）。

### 失败处理
- 权限缺失返回 `PERMISSION_DENIED`。
- 重复按下抖动只发出一次 `press`。

### 超时策略
- 无网络超时要求。
- 长按期间不重复发事件。

### 可观测字段
- `hotkey_press_count`、`hotkey_release_count`、`hotkey_debounce_drop_count`。

---

## 模块 4：Recorder（音频采集）

### 输入
- `start_recording()` / `stop_recording()` 指令。
- 麦克风音频流。

### 输出
- `AudioFrame`（100ms/chunk）推入有界队列。
- 停止时写入 Sentinel。

### 前置条件
- 麦克风权限已授予。
- 采样参数可被设备支持。

### 失败处理
- 无权限抛 `PERMISSION_DENIED`。
- 队列满时记录丢帧计数（MVP 不阻塞主线程）。

### 超时策略
- 达到 300 秒上限自动停录并写 Sentinel。

### 可观测字段
- `record_start_ts`、`record_duration_ms`、`chunks_total`、`chunks_dropped`。

---

## 模块 5：RecognizerAdapter（ASR 适配层）

### 输入
- `AudioFrame` 队列与 Sentinel。
- `api_key`、识别配置。

### 输出
- 标准 `RecognitionEvent`：`partial`、`final`、`error`。

### 前置条件
- API Key 存在且格式合法。
- 网络可用。

### 失败处理
- 鉴权失败 -> `AUTH_FAILED`。
- 网络中断/超时 -> `NETWORK_ERROR`。
- 返回结构不符 -> `ASR_PROTOCOL_ERROR`。

### 超时策略
- 单次请求 10 秒超时。
- `stop_session()` 后 3 秒未收到 final，则返回 error。

### 可观测字段
- `asr_first_partial_ms`、`asr_final_ms`、`asr_retry_count`、`asr_error_code`。

---

## 模块 6：PasteService（自动上屏）

### 输入
- `paste_text(text)`。

### 输出
- `PasteResult(success, reason, clipboard_restored)`。

### 前置条件
- 文本非空。
- 可读写文本剪贴板。
- 系统可发送 `Cmd+V`。

### 失败处理
- 无活动输入目标返回 `NO_ACTIVE_TARGET`。
- 粘贴失败时将文本保留在剪贴板并提示用户手动粘贴。

### 超时策略
- 粘贴动作后等待 100 ms 再恢复文本剪贴板。

### 可观测字段
- `paste_attempt_count`、`paste_success_count`、`clipboard_restore_success_count`。

---

## 模块 7：ConfigStore（配置存储）

### 输入
- `set_api_key()`、`set_hotkey()`。

### 输出
- `get_api_key()`、`get_hotkey()`。

### 前置条件
- 配置路径可访问。

### 失败处理
- 写入失败回滚旧值并提示。
- 读取损坏配置时回退默认值并重建。

### 超时策略
- 本地 I/O，不单独设置超时。

### 可观测字段
- `config_read_fail_count`、`config_write_fail_count`。

---

## 六、错误码字典（统一）

| code | 含义 | retryable |
|---|---|---|
| `PERMISSION_DENIED` | 麦克风/辅助功能权限不足 | true |
| `NETWORK_ERROR` | 网络异常或超时 | true |
| `AUTH_FAILED` | API Key 无效 | false |
| `NO_ACTIVE_TARGET` | 未检测到有效输入目标 | true |
| `ASR_PROTOCOL_ERROR` | ASR 返回内容不符合契约 | true |

---

## 七、接口约束

1. `SessionController.start_session()`：仅在 `IDLE` 有效。
2. `SessionController.stop_session()`：仅在 `RECORDING` 有效，需幂等。
3. `SessionController.cancel_session(reason)`：任意状态可调用，强制清理并回 `IDLE`。
4. `RecognizerAdapter` 对外只输出标准 `RecognitionEvent`，不透出底层 SDK 原始结构。
5. `PasteService` MVP 仅承诺文本剪贴板恢复能力。
