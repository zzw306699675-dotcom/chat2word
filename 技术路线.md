# macOS 实时语音转文字助手 —— 技术路线（MVP v2）

## 版本变更记录

| 版本 | 日期 | 变更人 | 说明 |
|---|---|---|---|
| v2.0 | 2026-02-21 | 设计评审整改 | 统一为 PySide6 主框架，移除 rumps；新增状态机、接口契约、错误码、失败时序；明确 MVP 范围与降级策略。 |
| v1.0 | 2026-02-21 | 初稿 | 初始技术路线。 |

---

## 一、产品定义

| 项目 | 说明 |
|---|---|
| 平台 | macOS |
| 形态 | 状态栏常驻应用（隐藏 Dock 图标） |
| 主框架 | PySide6（`QApplication` + `QSystemTrayIcon`） |
| 语言 | Python 3.10+ |
| 语音识别 | 阿里千问（通过 `RecognizerAdapter` 适配） |
| 目标版本 | 个人自用 MVP |

### 核心交互流程

```text
按下快捷键 -> start_session() -> 开始录音 -> 悬浮窗实时更新中间文本
松开快捷键 -> stop_session() -> 结束录音并收尾识别 -> 自动上屏 -> 恢复空闲状态
```

---

## 二、术语表

| 术语 | 定义 |
|---|---|
| Session | 一次按下到松开后的完整语音输入生命周期。 |
| PartialResult | 识别中间结果，可多次更新。 |
| FinalResult | 识别最终结果，只能出现一次。 |
| Sentinel | 队列结束哨兵（`None`），表示音频流结束。 |
| Paste | 将识别文本粘贴到当前焦点输入目标。 |

---

## 三、统一参数表

| 参数 | 值 | 说明 |
|---|---|---|
| 采样率 | 16000 Hz | 固定，满足识别输入要求。 |
| 声道 | 1 (mono) | 固定。 |
| 位深 | PCM 16-bit | 固定。 |
| 音频块大小 | 100 ms | 统一为 100ms，不再使用 200ms。 |
| 录音上限 | 5 分钟 | 到达上限自动触发 `stop_session()`。 |
| 音频队列容量 | 50 chunks | 有界队列，避免内存无上限增长。 |
| 上屏恢复延迟 | 100 ms | 粘贴后恢复文本剪贴板。 |
| 会话收尾超时 | 3 s | 松键后等待 FinalResult 的最大时长。 |
| 网络请求超时 | 10 s | 识别链路单次请求超时。 |

---

## 四、非目标范围（Out of Scope）

1. 公开分发所需签名、公证、企业级合规审计。
2. 富文本、图片、文件等复杂剪贴板格式的完整恢复。
3. 跨平台（Windows/Linux）支持。
4. 多云厂商动态路由或多模型并发融合。

---

## 五、架构决策

### 5.1 主框架决策

- 使用单一事件循环：`PySide6 QApplication`。
- 托盘功能改为 `QSystemTrayIcon`。
- 原 `rumps` 方案不再采用，避免多事件循环并存风险。

### 5.2 模块边界

| 模块 | 职责 | 不负责 |
|---|---|---|
| `SessionController` | 驱动状态机，编排录音/识别/上屏流程 | 具体 ASR 协议细节 |
| `HotkeyAdapter` | 将系统按键转换为 `press/release` 事件 | 业务状态判断 |
| `Recorder` | 输出标准化音频帧 | 识别逻辑 |
| `RecognizerAdapter` | 适配云端 SDK，产出标准事件 | UI 渲染 |
| `OverlayView` | 展示中间与状态文本 | 热键监听 |
| `PasteService` | 文本上屏与文本剪贴板恢复 | 富媒体恢复保证 |
| `ConfigStore` | API Key 和热键持久化 | 运行时业务编排 |

---

## 六、公开接口与类型契约

### 6.1 `SessionController`

```python
class SessionController:
    def start_session(self) -> None: ...
    def stop_session(self) -> None: ...
    def cancel_session(self, reason: str) -> None: ...
```

### 6.2 `AudioFrame`

```python
@dataclass
class AudioFrame:
    pcm16_bytes: bytes
    sample_rate: int = 16000
    channels: int = 1
    timestamp_ms: int = 0
```

### 6.3 `RecognitionEvent`

```python
# kind: partial | final | error
@dataclass
class RecognitionEvent:
    kind: str
    text: str = ""
    code: str = ""
    message: str = ""
    retryable: bool = False
```

### 6.4 `PasteService`

```python
@dataclass
class PasteResult:
    success: bool
    reason: str
    clipboard_restored: bool

class PasteService:
    def paste_text(self, text: str) -> PasteResult: ...
```

### 6.5 `ConfigStore`

```python
class ConfigStore:
    def get_api_key(self) -> str: ...
    def set_api_key(self, key: str) -> None: ...
    def get_hotkey(self) -> str: ...
    def set_hotkey(self, hotkey: str) -> None: ...
```

---

## 七、状态机与时序

### 7.1 会话状态机

```text
IDLE -> RECORDING -> FINALIZING -> PASTING -> IDLE
  |         |             |            |
  +-------->+------------>+----------> ERROR
```

### 7.2 状态转换规则

1. `IDLE -> RECORDING`：收到热键 `press` 且权限检查通过。
2. `RECORDING -> FINALIZING`：收到热键 `release` 或达到 5 分钟上限。
3. `FINALIZING -> PASTING`：收到 `FinalResult` 且非空。
4. `PASTING -> IDLE`：`PasteResult.success = true`。
5. 任意状态 -> `ERROR`：权限错误、鉴权失败、网络异常、协议解析异常、超时。
6. `ERROR -> IDLE`：错误处理完成并清理资源后回空闲。

### 7.3 失败路径时序（固定）

1. 记录错误码与错误消息。
2. 停止录音并写入 Sentinel。
3. 关闭/重置识别会话。
4. 悬浮窗显示可读错误提示（2 秒后隐藏）。
5. 清理线程和队列，回到 `IDLE`。

---

## 八、错误码字典

| 错误码 | 含义 | 默认提示 | 是否可重试 |
|---|---|---|---|
| `PERMISSION_DENIED` | 麦克风或辅助功能权限被拒 | 请在系统设置中授权后重试 | 是 |
| `NETWORK_ERROR` | 网络中断或超时 | 网络异常，请检查连接 | 是 |
| `AUTH_FAILED` | API Key 无效或过期 | API Key 无效，请重新配置 | 否 |
| `NO_ACTIVE_TARGET` | 当前无可粘贴目标 | 未检测到可输入位置，结果已保留到剪贴板 | 是 |
| `ASR_PROTOCOL_ERROR` | 识别返回结构异常 | 识别服务返回异常，请重试 | 是 |

---

## 九、并发与资源治理

1. 线程模型：UI 主线程 + 录音线程 + 识别线程。
2. 队列模型：有界 `Queue(maxsize=50)`，生产消费速率监控。
3. 停止机制：使用 Sentinel + 超时等待，`stop_session()` 必须幂等。
4. 内存控制：录音超时硬截止，识别缓存只保留必要上下文。

---

## 十、开发路线图

| 阶段 | 目标 | 产出 |
|---|---|---|
| Phase 1 | CLI 链路打通：录音 -> 识别 -> 控制台输出 | 验证 ASR 适配接口 |
| Phase 2 | 接入 `SessionController` + 状态机 | 可控的会话生命周期 |
| Phase 3 | 托盘与悬浮窗接入 PySide6 | 可用的桌面交互闭环 |
| Phase 4 | 自动上屏与错误提示完善 | MVP 可日常自用 |
| Phase 5 | 测试基线和打包验证 | 可复现的交付版本 |
