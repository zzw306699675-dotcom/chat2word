# macOS 实时语音转文字助手 —— 测试方案（MVP v2）

## 版本变更记录

| 版本 | 日期 | 变更人 | 说明 |
|---|---|---|---|
| v2.0 | 2026-02-21 | 设计评审整改 | 测试分层重构为 unit/integration/e2e/manual；明确 CI 集合与本地集合；加入验收映射。 |
| v1.0 | 2026-02-21 | 初稿 | 初始自动化测试方案。 |

---

## 一、术语表

| 术语 | 定义 |
|---|---|
| Unit | 对单模块进行纯逻辑测试，外部依赖全部 Mock。 |
| Integration | 多模块协同测试，允许进程内真实调用，外部服务可替身。 |
| E2E | 从热键触发到上屏完成的端到端测试。 |
| Manual | 需要人工操作或系统权限配合的验证项。 |

---

## 二、统一参数表

| 参数 | 值 |
|---|---|
| Python | 3.10+ |
| pytest | 最新稳定版 |
| 音频输入规格 | 16kHz / mono / PCM16 |
| 录音上限 | 300 秒 |
| 覆盖率目标（核心逻辑） | >= 85% |
| 状态机分支覆盖 | 100% |

---

## 三、非目标范围（Out of Scope）

1. CI 中验证真实系统权限弹窗行为。
2. CI 中验证全屏游戏覆盖等强系统耦合 UI 场景。
3. 富媒体剪贴板恢复自动化验证（MVP 不承诺该能力）。

---

## 四、测试分层设计

## 4.1 Unit（每次提交必跑）

覆盖模块：
1. `SessionController` 状态机转换与幂等行为。
2. `HotkeyAdapter` 防抖与重复触发过滤。
3. `Recorder` 的队列投递、Sentinel 注入、超时停录逻辑（Mock 麦克风）。
4. `RecognizerAdapter` 事件标准化与错误映射（Mock ASR SDK）。
5. `PasteService` 文本剪贴板保存/恢复与失败返回。
6. `ConfigStore` 读写、损坏恢复、默认值回退。

关键断言：
1. 状态机路径 `IDLE->RECORDING->FINALIZING->PASTING->IDLE` 全覆盖。
2. 错误路径均可回到 `IDLE`。
3. `stop_session()` 多次调用不抛异常。

---

## 4.2 Integration（PR 必跑）

覆盖场景：
1. 录音队列 + 识别适配层联调（使用本地 wav 回放而非真实麦克风）。
2. `SessionController` + `RecognizerAdapter` + `PasteService` 联调。
3. UI 事件总线联调：中间文本可驱动 `OverlayView` 更新。

关键断言：
1. PartialResult 能多次更新且 FinalResult 只出现一次。
2. 识别错误后，资源被清理且状态回到 `IDLE`。
3. 上屏失败时文本保留并返回 `NO_ACTIVE_TARGET`。

---

## 4.3 E2E（主干每日定时）

执行条件：macOS Runner + 专用测试账号。

覆盖场景：
1. 短按流程：开始后快速结束，仍能安全收尾。
2. 长按流程：连续录音 5-10 秒并成功上屏。
3. 断网流程：进行中断网，返回 `NETWORK_ERROR`。
4. 错误 API Key：返回 `AUTH_FAILED`，不崩溃。

说明：
1. E2E 使用受控测试窗口作为输入目标，避免随机焦点导致误报。
2. 真实云端调用设置每日限流预算。

---

## 4.4 Manual（发布前人工验证）

覆盖场景：
1. 麦克风权限拒绝与恢复。
2. 辅助功能权限拒绝与恢复。
3. 两个目标应用中的实机上屏体验（如浏览器、编辑器）。
4. 输入法切换状态下的 Cmd+V 粘贴可用性。
5. 连续 30 次短按 + 10 次长按稳定性。

---

## 五、测试用例清单（与验收标准对齐）

| 编号 | 层级 | 场景 | 预期结果 |
|---|---|---|---|
| TC-SM-01 | Unit | 主流程状态机 | 正确流转并回到 `IDLE` |
| TC-SM-02 | Unit | 异常回收 | 任意异常都能清理资源并回空闲 |
| TC-HK-01 | Unit | 热键防抖 | 长按只触发一次 press、一次 release |
| TC-AR-01 | Unit | 录音上限 | 达到 300s 自动停录并写 Sentinel |
| TC-ASR-01 | Unit | 事件标准化 | SDK 原始返回被转换为标准 `RecognitionEvent` |
| TC-ASR-02 | Integration | 网络错误映射 | 正确输出 `NETWORK_ERROR` |
| TC-ASR-03 | Integration | 鉴权失败映射 | 正确输出 `AUTH_FAILED` |
| TC-PS-01 | Unit | 文本剪贴板恢复 | `clipboard_restored=true` |
| TC-PS-02 | Integration | 无输入目标 | 返回 `NO_ACTIVE_TARGET`，文本保留 |
| TC-E2E-01 | E2E | 真实短语识别上屏 | 输入窗口收到目标文本 |
| TC-MAN-01 | Manual | 权限拒绝恢复 | 具备可读提示，恢复后可继续使用 |

---

## 六、CI/CD 执行策略

## 6.1 CI 必跑集合（push / pull_request）

1. `pytest -m "unit or integration" --maxfail=1`
2. 覆盖率门禁：核心逻辑 >= 85%。
3. 状态机分支覆盖检查：`SessionController` 必须 100%。

## 6.2 主干定时集合（daily）

1. `pytest -m e2e`
2. 运行在 macOS runner。
3. 使用测试 API Key 与限流预算。

## 6.3 本地发布前集合

1. `pytest -m "unit or integration or e2e"`
2. 按 `Manual` 清单逐项人工勾验。

---

## 七、示例工作流（可直接作为基础模板）

```yaml
name: macOS ASR Tests
on:
  push:
  pull_request:
  schedule:
    - cron: '0 2 * * *'

jobs:
  ci-fast:
    if: github.event_name != 'schedule'
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - run: pip install -r requirements.txt
      - run: pip install pytest pytest-cov pytest-qt pytest-asyncio
      - run: pytest -m "unit or integration" --cov=. --cov-fail-under=85

  e2e-daily:
    if: github.event_name == 'schedule'
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - run: pip install -r requirements.txt
      - run: pip install pytest pytest-qt pytest-asyncio
      - run: pytest -m e2e -v
```

---

## 八、验收映射（摘要）

1. 主流程闭环 -> `TC-SM-01` + `TC-E2E-01`。
2. 权限异常可恢复 -> `TC-MAN-01`。
3. ASR 错误治理 -> `TC-ASR-02` + `TC-ASR-03`。
4. 上屏失败兜底 -> `TC-PS-02`。
5. 并发稳定性 -> `Manual` 压测项。
